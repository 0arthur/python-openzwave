{{- g.fanstatic.needs('js.bootstrap:bootstrap') -}}
{{- g.fanstatic.needs('js.bootstrap:bootstrap_theme') -}}
{{- g.fanstatic.needs('js.jquery:jquery') -}}
{{- g.fanstatic.needs('js.jquery_datatables:jquery_datatables') -}}
{{- g.fanstatic.needs('js.jquery_datatables:responsive') -}}
{{- g.fanstatic.needs('js.socketio:socketio') -}}
{% extends "layout.html" %}
{% import 'widgets.html' as widgets %}
{% block content %}
    <script type="text/javascript" charset="utf-8">
        var namespace = '/ozwave'; // change to an empty string to use the global namespace
        // the socket.io documentation recommends sending an explicit package upon connection
        // this is specially important when using the global namespace
        var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
        // event handler for server sent data
        // the data is displayed in the "Received" section of the page
    </script>
    <script type="text/javascript" src="/static/js/zwnetwork.js" charset="utf-8"></script>
    <script type="text/javascript" src="/static/js/cytoscape.min.js" charset="utf-8"></script>
    <h2>Network:</h2>
    <form id="map_save_form" name="map_save_form">
        <input type='submit' id="map_save_button" name="map_save_button" value="Save map">
        <script type="text/javascript" charset="utf-8">
            $('form#map_save_form').submit(function(event) {
                //Need to optimize it
                $.each(window.ozw_map.nodes(), function (key, item) {
                    console.log(key, item);
                    socket.emit('my node event', {node_id:item.data('id'), posx:item.position('x'), posy:item.position('y')});
                });
                return false;
            });
        </script>
        </form>

    <div id="ozw_map"></div>

    <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
        $('#ozw_map').cytoscape({
          style: cytoscape.stylesheet()
            .selector('node')
              .css({
                'content': 'data(name)',
                'text-valign': 'center',
                'color': 'white',
                'text-outline-width': 2,
                'text-outline-color': '#888'
              })
            .selector('edge')
              .css({
                'target-arrow-shape': 'triangle'
              })
            .selector(':selected')
              .css({
                'background-color': 'black',
                'line-color': 'black',
                'target-arrow-color': 'black',
                'source-arrow-color': 'black'
              })
            .selector('.faded')
              .css({
                'opacity': 0.25,
                'text-opacity': 0
              }),

          //~ elements: {
            //~ nodes: [
              //~ { data: { id: 'j', name: 'Jerry' } },
              //~ { data: { id: 'e', name: 'Elaine' } },
              //~ { data: { id: 'k', name: 'Kramer' } },
              //~ { data: { id: 'g', name: 'George' } }
            //~ ],
            //~ edges: [
              //~ { data: { source: 'j', target: 'e' } },
              //~ { data: { source: 'j', target: 'k' } },
              //~ { data: { source: 'j', target: 'g' } },
              //~ { data: { source: 'e', target: 'j' } },
              //~ { data: { source: 'e', target: 'k' } },
              //~ { data: { source: 'k', target: 'j' } },
              //~ { data: { source: 'k', target: 'e' } },
              //~ { data: { source: 'k', target: 'g' } },
              //~ { data: { source: 'g', target: 'j' } }
            //~ ]
          //~ },

          layout: {
            name: 'grid',
            padding: 10
          },

          // on graph initial layout done (could be async depending on layout...)
          ready: function(){
            window.ozw_map = this;

            // giddy up...

            ozw_map.elements().unselectify();

            ozw_map.on('tap', 'node', function(e){
              var node = e.cyTarget;
              var neighborhood = node.neighborhood().add(node);

              ozw_map.elements().addClass('faded');
              neighborhood.removeClass('faded');
            });

            ozw_map.on('tap', function(e){
              if( e.cyTarget === ozw_map ){
                ozw_map.elements().removeClass('faded');
              }
            });
          }
        });

        socket.on('my nodes response', function(msg) {
            console.log("Received nodes response : " + msg.data);
            data = {nodes : [], edges : []};
            $.each(msg.data, function (key, item) {
                data['nodes'].push({data:{id:''+item["node_id"], name: item["name"]}})
                if (item['neighbors'] != undefined) {
                    $.each(item['neighbors'], function (key2, item2) {
                        data['edges'].push({data:{id:''+item["node_id"]+'-'+key2, source:''+item["node_id"], target: ''+key2}})
                    });
                }
            });
            window.ozw_map.load(data);
        });

        socket.on('my node response', function(msg) {
            console.log("Received node response : " + msg.data['node_id']);
            cynode = window.ozw_map.$('#'+msg.data['node_id']);
            cynode.data({name:msg.data['name']});
            window.ozw_map.forceRender()
        });

        socket.emit('my network event', {});
        socket.emit('my nodes event', {});

    } );

    </script>
{% endblock %}
